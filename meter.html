<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>メーター記録 v16</title>
    <link rel="icon" href="data:image/svg+xml,%3csvg width='32' height='32' viewBox='0 0 32 32' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='16' cy='16' r='14' stroke='%233b82f6' stroke-width='3' fill='none'/%3e%3cline x1='16' y1='16' x2='26' y2='8' stroke='%23ef4444' stroke-width='3' stroke-linecap='round'/%3e%3c/svg%3e">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .meter-btn.active { background-color: #16a34a; color: white; border-color: #16a34a; }
        .keypad-btn { transition: background-color 0.2s; }
        .keypad-btn:active { background-color: #d1d5db; }
        .display-active { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        #value-display { word-wrap: break-word; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-sm">
        <header class="text-center mb-6 relative">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">メーター記録ツール</h1>
            <span class="absolute top-0 right-0 text-xs text-gray-400">v16</span>
        </header>

        <main class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
            <div id="main-error-message" class="hidden"></div>
            <div id="main-success-message" class="hidden"></div>

            <!-- メーター種別選択 -->
            <div class="mb-4">
                <h3 class="text-md font-semibold mb-2 text-gray-700">1. メーター種別を選択</h3>
                <div class="grid grid-cols-4 gap-2">
                    <button class="meter-btn border-2 border-gray-300 p-2 text-sm rounded-lg font-medium" data-type="電気">電気</button>
                    <button class="meter-btn border-2 border-gray-300 p-2 text-sm rounded-lg font-medium" data-type="水道">水道</button>
                    <button class="meter-btn border-2 border-gray-300 p-2 text-sm rounded-lg font-medium" data-type="下水道">下水道</button>
                    <button class="meter-btn border-2 border-gray-300 p-2 text-sm rounded-lg font-medium" data-type="ガス">ガス</button>
                </div>
            </div>

            <!-- 表示エリア -->
            <div id="display-area" class="mb-4 space-y-2">
                 <div id="number-display-wrapper" class="p-3 bg-gray-100 rounded-lg border-2 border-transparent transition-all">
                    <label class="block text-sm font-medium text-gray-400">メーター番号</label>
                    <div id="number-display" class="text-2xl font-mono text-right text-gray-800 h-8"></div>
                </div>
                 <div id="value-display-wrapper" class="p-3 bg-gray-100 rounded-lg border-2 border-transparent transition-all">
                    <label class="block text-sm font-medium text-gray-400">数値</label>
                    <div id="value-display" class="text-2xl font-mono text-right text-gray-800 min-h-[32px]"></div>
                </div>
            </div>

            <!-- キーパッド -->
            <div class="grid grid-cols-4 gap-2 text-xl">
                <button class="keypad-btn bg-gray-200 p-4 rounded-lg font-semibold" data-key="7">7</button>
                <button class="keypad-btn bg-gray-200 p-4 rounded-lg font-semibold" data-key="8">8</button>
                <button class="keypad-btn bg-gray-200 p-4 rounded-lg font-semibold" data-key="9">9</button>
                <button class="keypad-btn bg-yellow-400 p-4 rounded-lg font-semibold" data-key="C">C</button>
                
                <button class="keypad-btn bg-gray-200 p-4 rounded-lg font-semibold" data-key="4">4</button>
                <button class="keypad-btn bg-gray-200 p-4 rounded-lg font-semibold" data-key="5">5</button>
                <button class="keypad-btn bg-gray-200 p-4 rounded-lg font-semibold" data-key="6">6</button>
                <button class="keypad-btn bg-red-400 p-4 rounded-lg font-semibold text-white" data-key="BS">⌫</button>
                
                <button class="keypad-btn bg-gray-200 p-4 rounded-lg font-semibold" data-key="1">1</button>
                <button class="keypad-btn bg-gray-200 p-4 rounded-lg font-semibold" data-key="2">2</button>
                <button class="keypad-btn bg-gray-200 p-4 rounded-lg font-semibold" data-key="3">3</button>
                <button class="keypad-btn bg-gray-200 p-4 rounded-lg font-semibold" data-key="+">+</button>

                <button class="keypad-btn bg-gray-200 col-span-2 p-4 rounded-lg font-semibold" data-key="0">0</button>
                <button class="keypad-btn bg-gray-200 p-4 rounded-lg font-semibold" data-key=".">.</button>
                <button id="enter-button" class="keypad-btn bg-blue-500 text-white p-4 rounded-lg font-semibold flex items-center justify-center" data-key="Enter">次へ</button>
            </div>
             <div id="loader-container" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16"></div>
            </div>
        </main>
    </div>

    <script>
        // --- ▼▼▼ 管理者の方へ：ここに設定を貼り付けてください ▼▼▼ ---
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzWHU_W4LRs_MqBVyS6sUtl2HFOo8BsKJraysPuH1FuhZ_G-IeZkTmUJmBkX7abJMt4fg/exec";
        // --- ▲▲▲ 設定はここまで ▲▲▲ ---

        // --- DOM要素 ---
        const meterBtns = document.querySelectorAll('.meter-btn');
        const keypadBtns = document.querySelectorAll('.keypad-btn');
        const mainErrorMessage = document.getElementById('main-error-message');
        const mainSuccessMessage = document.getElementById('main-success-message');
        const numberDisplay = document.getElementById('number-display');
        const valueDisplay = document.getElementById('value-display');
        const numberWrapper = document.getElementById('number-display-wrapper');
        const valueWrapper = document.getElementById('value-display-wrapper');
        const loaderContainer = document.getElementById('loader-container');
        const enterButton = document.getElementById('enter-button');

        // --- グローバル変数 ---
        let activeMeterType = '';
        let currentInputMode = 'number'; // 'number' or 'value'
        let meterNumber = '';
        let valueExpression = '';

        // --- UIロジック ---
        function showMessage(element, message, isError = false) {
            element.textContent = message;
            element.className = isError ? 'block text-center text-red-500 bg-red-100 p-3 rounded-lg mb-4 text-sm' : 'block text-center text-green-500 bg-green-100 p-3 rounded-lg mb-4 text-sm';
            setTimeout(() => { element.className = 'hidden'; }, 3000);
        }

        function updateDisplay() {
            numberDisplay.textContent = meterNumber || '';
            valueDisplay.textContent = valueExpression || '';

            numberWrapper.classList.toggle('display-active', currentInputMode === 'number');
            valueWrapper.classList.toggle('display-active', currentInputMode === 'value');
            
            enterButton.textContent = (currentInputMode === 'number') ? '次へ' : '記録';
        }
        
        function resetAll() {
            meterNumber = '';
            valueExpression = '';
            activeMeterType = '';
            currentInputMode = 'number';
            meterBtns.forEach(b => b.classList.remove('active'));
            updateDisplay();
        }

        function initApp() {
            if (!APPS_SCRIPT_URL) {
                showMessage(mainErrorMessage, '【管理者の方へ】アプリの設定が完了していません。', true);
                document.querySelector('main').style.pointerEvents = 'none';
                return;
            }
            meterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    meterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    activeMeterType = btn.dataset.type;
                });
            });
            keypadBtns.forEach(btn => {
                btn.addEventListener('click', () => handleKeyPress(btn.dataset.key));
            });
            updateDisplay();
        }
        
        function handleKeyPress(key) {
            if (currentInputMode === 'number') {
                handleNumberInput(key);
            } else {
                handleValueInput(key);
            }
            updateDisplay();
        }

        function handleNumberInput(key) {
            if (/\d/.test(key)) {
                meterNumber += key;
            } else if (key === '.' && !meterNumber.includes('.')) {
                meterNumber += key;
            } else if (key === 'BS') {
                meterNumber = meterNumber.slice(0, -1);
            }
        }

        function handleValueInput(key) {
            const lastChar = valueExpression.trim().slice(-1);
            if (/\d/.test(key)) {
                valueExpression += key;
            } else if (key === '.' && !/\./.test(valueExpression.split('+').pop())) {
                valueExpression += key;
            } else if (key === '+' && valueExpression && !isNaN(lastChar)) {
                 valueExpression += ' + ';
            } else if (key === 'BS') {
                valueExpression = valueExpression.trimEnd().slice(0, -1).trimEnd();
            }
        }

        function handleGlobalKeys(key) {
            if (key === 'C') {
                resetAll();
            } else if (key === 'Enter') {
                handleEnterPress();
            }
        }

        function handleKeyPress(key) {
            if (key === 'C' || key === 'Enter') {
                handleGlobalKeys(key);
            } else if (currentInputMode === 'number') {
                handleNumberInput(key);
            } else {
                handleValueInput(key);
            }
            updateDisplay();
        }

        function handleEnterPress() {
            if (currentInputMode === 'number') {
                if (meterNumber) {
                    currentInputMode = 'value';
                }
            } else if (currentInputMode === 'value') {
                if (!activeMeterType) {
                    showMessage(mainErrorMessage, "先にメーター種別を選択してください。", true);
                    return;
                }
                if (!meterNumber || !valueExpression) {
                    showMessage(mainErrorMessage, "番号と数値を両方入力してください。", true);
                    return;
                }
                
                try {
                    // 安全のため、式を評価する前に簡単なサニタイズ
                    const sanitizedExpression = valueExpression.replace(/[^-()\d/*+.]/g, '');
                    const sum = new Function('return ' + sanitizedExpression)();
                    saveData(activeMeterType, meterNumber, sum);
                } catch (e) {
                    showMessage(mainErrorMessage, "計算式が正しくありません。", true);
                }
            }
        }

        // --- 機能ロジック ---
        function saveData(meterType, number, value) {
            loaderContainer.classList.remove('hidden');

            const payload = { meterType, meterNumber: number, value: value, imageData: null };
            
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { 'Content-Type': 'application/json' },
                mode: 'no-cors'
            }).catch(console.warn);

            setTimeout(() => {
                loaderContainer.classList.add('hidden');
                showMessage(mainSuccessMessage, '記録されました！', false);
                resetAll();
            }, 1000);
        }

        window.addEventListener('load', initApp);
    </script>
</body>
</html>

